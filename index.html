<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
  <title>Hyun's Briefing</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&family=IBM+Plex+Mono:wght@400;500&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #0d1117;
      --surface: #161b22;
      --surface2: #1c2333;
      --border: #30363d;
      --accent: #388bfd;
      --up: #3fb950;
      --down: #f85149;
      --gold: #d2991e;
      --text: #e6edf3;
      --muted: #6e7681;
      --muted2: #484f58;
      --mono: 'IBM Plex Mono', monospace;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Noto Sans KR', sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      font-size: 14px;
    }

    /* ── HEADER ── */
    .header {
      background: var(--bg);
      border-bottom: 1px solid var(--border);
      padding: 13px 16px;
      position: sticky;
      top: 0;
      z-index: 200;
    }
    .header-inner {
      max-width: 820px;
      margin: 0 auto;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }
    .header-left h1 {
      font-size: 15px;
      font-weight: 700;
      letter-spacing: -0.3px;
      color: var(--text);
    }
    .header-left p {
      font-size: 10px;
      color: var(--muted);
      margin-top: 2px;
      font-family: var(--mono);
    }
    .header-btns { display: flex; gap: 7px; flex-shrink: 0; }
    .btn {
      padding: 7px 13px;
      border-radius: 5px;
      border: 1px solid var(--border);
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      font-family: 'Noto Sans KR', sans-serif;
      transition: opacity .15s, transform .1s;
      letter-spacing: -0.2px;
    }
    .btn:active { opacity: .7; transform: scale(.96); }
    .btn-copy { background: var(--surface2); color: var(--text); }
    .btn-tg   { background: #1d6fa4; color: #fff; border-color: #1d6fa4; }

    /* ── LAYOUT ── */
    .content {
      max-width: 820px;
      margin: 0 auto;
      padding: 16px 16px 60px;
      display: flex;
      flex-direction: column;
      gap: 14px;
    }

    /* ── SECTION HEADER ── */
    .sec-label {
      font-size: 10px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: var(--muted);
      padding-bottom: 6px;
      border-bottom: 1px solid var(--border);
      margin-bottom: 10px;
    }

    /* ── TELEGRAM PANEL ── */
    .tg-panel {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 8px;
      overflow: hidden;
    }
    .tg-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 11px 14px;
      cursor: pointer;
      user-select: none;
    }
    .tg-header:hover { background: var(--surface2); }
    .tg-title { font-size: 12px; font-weight: 600; color: var(--accent); }
    .tg-arrow { font-size: 10px; color: var(--muted); transition: transform .2s; }
    .tg-arrow.open { transform: rotate(180deg); }
    .tg-body { padding: 0 14px 14px; display: none; }
    .tg-body.open { display: block; }

    .field-group { margin-bottom: 10px; }
    .field-group:last-of-type { margin-bottom: 0; }
    .field-group label {
      display: block;
      font-size: 10px;
      color: var(--muted);
      margin-bottom: 4px;
      font-family: var(--mono);
      text-transform: uppercase;
      letter-spacing: .5px;
    }
    .field-group input {
      width: 100%;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 5px;
      padding: 8px 10px;
      color: var(--text);
      font-size: 12px;
      font-family: var(--mono);
      outline: none;
    }
    .field-group input:focus { border-color: var(--accent); }
    .field-group input::placeholder { color: var(--muted2); }

    .tg-help {
      font-size: 10px;
      color: var(--muted);
      line-height: 1.8;
      padding: 8px 10px;
      background: var(--bg);
      border-radius: 5px;
      margin-top: 10px;
      border: 1px solid var(--border);
      font-family: var(--mono);
    }
    .tg-help a { color: var(--accent); text-decoration: none; }

    /* ── STATUS ── */
    .status {
      font-size: 12px;
      padding: 9px 13px;
      border-radius: 6px;
      display: none;
      font-family: var(--mono);
    }
    .status.show { display: block; }
    .status.ok  { background: rgba(63,185,80,.1); color: var(--up); }
    .status.err { background: rgba(248,81,73,.1); color: var(--down); }
    .status.loading { background: rgba(56,139,253,.08); color: var(--accent); }

    /* ── UPDATE BADGE ── */
    .update-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 10px;
      font-family: var(--mono);
      color: var(--up);
      background: rgba(63,185,80,.08);
      border: 1px solid rgba(63,185,80,.2);
      border-radius: 4px;
      padding: 4px 10px;
      margin-bottom: 4px;
    }
    .update-dot {
      width: 5px; height: 5px;
      border-radius: 50%;
      background: var(--up);
    }

    /* ── BRIEFING TEXT ── */
    .brief-box {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 8px;
      overflow: hidden;
    }
    .brief-toolbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 9px 13px;
      border-bottom: 1px solid var(--border);
      background: var(--surface2);
    }
    .brief-toolbar-l { font-size: 10px; color: var(--muted); font-family: var(--mono); }
    .btn-reset {
      background: transparent;
      border: 1px solid var(--border);
      border-radius: 4px;
      color: var(--muted);
      font-size: 10px;
      padding: 3px 8px;
      cursor: pointer;
      font-family: var(--mono);
      transition: color .15s;
    }
    .btn-reset:hover { color: var(--text); }

    #briefing-text {
      display: block;
      width: 100%;
      min-height: 620px;
      background: transparent;
      border: none;
      color: var(--text);
      font-family: var(--mono);
      font-size: 13px;
      line-height: 1.85;
      padding: 16px;
      resize: vertical;
      outline: none;
      white-space: pre;
    }

    /* ── FINVIZ SECTION ── */
    .finviz-section {
      display: flex;
      flex-direction: column;
      gap: 14px;
    }

    .chart-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 8px;
      overflow: hidden;
    }

    .chart-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 14px;
      border-bottom: 1px solid var(--border);
      background: var(--surface2);
    }

    .chart-title { font-size: 11px; font-weight: 700; color: var(--text); text-transform: uppercase; letter-spacing: .8px; }
    .chart-source { font-size: 10px; color: var(--muted); font-family: var(--mono); }

    .treemap-wrap {
      position: relative;
      background: #1a1f2e;
      min-height: 200px;
    }

    .treemap-wrap img {
      width: 100%;
      display: block;
      border: none;
    }

    .treemap-overlay {
      position: absolute;
      inset: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background: rgba(13,17,23,.8);
      gap: 10px;
    }

    .treemap-overlay p { font-size: 12px; color: var(--muted); text-align: center; line-height: 1.6; }
    .btn-open-finviz {
      background: var(--accent);
      color: #fff;
      border: none;
      border-radius: 5px;
      padding: 8px 16px;
      font-size: 12px;
      font-weight: 700;
      cursor: pointer;
      font-family: 'Noto Sans KR', sans-serif;
      text-decoration: none;
      display: inline-block;
    }

    .sector-chart { padding: 16px 14px; }

    .sector-row {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 9px;
    }
    .sector-row:last-child { margin-bottom: 0; }

    .sector-name {
      font-size: 11px;
      color: var(--text);
      width: 130px;
      flex-shrink: 0;
      text-align: right;
    }

    .bar-track {
      flex: 1;
      height: 18px;
      background: var(--surface2);
      border-radius: 3px;
      position: relative;
      overflow: hidden;
    }

    .bar-fill {
      position: absolute;
      top: 0;
      height: 100%;
      border-radius: 3px;
      display: flex;
      align-items: center;
      padding: 0 7px;
      font-family: var(--mono);
      font-size: 10px;
      font-weight: 500;
      white-space: nowrap;
      transition: width .8s cubic-bezier(.4,0,.2,1);
    }

    .bar-fill.up   { background: rgba(63,185,80,.25);  color: var(--up);   left: 0; }
    .bar-fill.down { background: rgba(248,81,73,.22);  color: var(--down); right: 0; justify-content: flex-end; }

    .finviz-note {
      font-size: 10px;
      color: var(--muted);
      font-family: var(--mono);
      padding: 8px 14px;
      border-top: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .finviz-note a { color: var(--accent); text-decoration: none; }

    /* ── FOOTER ── */
    .footer {
      text-align: center;
      font-size: 10px;
      color: var(--muted);
      line-height: 1.8;
      padding-top: 4px;
      font-family: var(--mono);
    }

    /* ── NEWS ── */
    .news-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 8px;
      overflow: hidden;
    }

    .news-item {
      padding: 14px;
      border-bottom: 1px solid var(--border);
      display: flex;
      gap: 12px;
    }
    .news-item:last-child { border-bottom: none; }

    .news-tag {
      flex-shrink: 0;
      font-size: 9px;
      font-weight: 700;
      font-family: var(--mono);
      padding: 3px 7px;
      border-radius: 3px;
      text-transform: uppercase;
      letter-spacing: .5px;
      height: fit-content;
      margin-top: 2px;
    }
    .tag-fed     { background: rgba(56,139,253,.15); color: var(--accent); border: 1px solid rgba(56,139,253,.3); }
    .tag-geo     { background: rgba(248,81,73,.12);  color: var(--down);   border: 1px solid rgba(248,81,73,.3); }
    .tag-macro   { background: rgba(63,185,80,.12);  color: var(--up);     border: 1px solid rgba(63,185,80,.3); }
    .tag-corp    { background: rgba(210,153,34,.12); color: var(--gold);   border: 1px solid rgba(210,153,34,.3); }
    .tag-market  { background: rgba(139,148,158,.1); color: #8b949e;       border: 1px solid rgba(139,148,158,.2); }

    .news-headline {
      font-size: 13px;
      font-weight: 600;
      color: var(--text);
      margin-bottom: 5px;
      line-height: 1.4;
    }
    .news-desc {
      font-size: 11px;
      color: var(--muted);
      line-height: 1.6;
    }
    .news-source {
      font-size: 10px;
      color: var(--muted2);
      font-family: var(--mono);
      margin-top: 5px;
    }

    /* Outlook */
    .outlook-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 8px;
      overflow: hidden;
    }

    .outlook-summary {
      padding: 14px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      gap: 14px;
    }

    .outlook-verdict {
      flex-shrink: 0;
      text-align: center;
    }

    .verdict-label {
      font-size: 9px;
      color: var(--muted);
      font-family: var(--mono);
      text-transform: uppercase;
      letter-spacing: .5px;
      margin-bottom: 4px;
    }

    .verdict-value {
      font-size: 22px;
      font-weight: 700;
    }
    .verdict-up   { color: var(--up); }
    .verdict-flat { color: var(--gold); }
    .verdict-down { color: var(--down); }

    .outlook-summary-text {
      font-size: 12px;
      color: var(--text);
      line-height: 1.65;
    }

    .outlook-item {
      padding: 13px 14px;
      border-bottom: 1px solid var(--border);
      display: flex;
      gap: 10px;
      align-items: flex-start;
    }
    .outlook-item:last-child { border-bottom: none; }

    .outlook-dot {
      width: 6px; height: 6px;
      border-radius: 50%;
      flex-shrink: 0;
      margin-top: 6px;
    }
    .dot-up   { background: var(--up); }
    .dot-down { background: var(--down); }
    .dot-flat { background: var(--gold); }

    .outlook-text {
      font-size: 12px;
      color: var(--text);
      line-height: 1.6;
    }
    .outlook-text strong { color: var(--text); font-weight: 600; }
    .outlook-sub {
      font-size: 10px;
      color: var(--muted);
      margin-top: 3px;
      font-family: var(--mono);
    }

    .outlook-disclaimer {
      font-size: 10px;
      color: var(--muted2);
      font-family: var(--mono);
      padding: 10px 14px;
      border-top: 1px solid var(--border);
      background: var(--surface2);
    }

    /* ── LANDING ── */
    #landing {
      position: fixed;
      inset: 0;
      background: var(--bg);
      z-index: 999;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 0;
    }

    .landing-title {
      font-size: 32px;
      font-weight: 700;
      color: var(--text);
      letter-spacing: -1px;
      margin-bottom: 6px;
    }

    .landing-title span { color: var(--accent); }

    .landing-sub {
      font-size: 12px;
      color: var(--muted);
      font-family: var(--mono);
      margin-bottom: 48px;
      letter-spacing: .5px;
    }

    .landing-date {
      font-size: 11px;
      color: var(--muted2);
      font-family: var(--mono);
      margin-bottom: 32px;
      padding: 6px 14px;
      border: 1px solid var(--border);
      border-radius: 20px;
    }

    .btn-enter {
      background: var(--accent);
      color: #fff;
      border: none;
      border-radius: 8px;
      padding: 14px 40px;
      font-size: 14px;
      font-weight: 700;
      cursor: pointer;
      font-family: 'Noto Sans KR', sans-serif;
      letter-spacing: -0.2px;
      transition: opacity .15s, transform .15s;
    }

    .btn-enter:hover  { opacity: .88; }
    .btn-enter:active { transform: scale(.97); }

    .landing-divider {
      width: 1px;
      height: 40px;
      background: var(--border);
      margin-bottom: 32px;
    }

    #landing.hide {
      animation: fadeOut .35s ease forwards;
    }

    @keyframes fadeOut {
      to { opacity: 0; pointer-events: none; }
    }

    #main-content { display: none; }
    #main-content.show { display: block; }
  </style>
</head>
<body>

<!-- LANDING -->
<div id="landing">
  <div class="landing-title">Hyun's <span>Briefing</span></div>
  <div class="landing-sub">US MARKET DAILY REPORT</div>
  <div class="landing-date" id="landing-date">로딩 중...</div>
  <div class="landing-divider"></div>
  <button class="btn-enter" onclick="enterBriefing()">오늘의 시황 보기</button>
</div>

<div id="main-content">

<!-- HEADER -->
<div class="header">
  <div class="header-inner">
    <div class="header-left">
      <h1>Hyun's Briefing</h1>
      <p id="header-date">로딩 중...</p>
    </div>
    <div class="header-btns">
      <button class="btn btn-copy" onclick="copyBriefing()">복사</button>
      <button class="btn btn-tg" onclick="sendToTelegram()">텔레그램 전송</button>
    </div>
  </div>
</div>

<div class="content">

  <!-- TELEGRAM SETTINGS -->
  <div class="tg-panel">
    <div class="tg-header" onclick="toggleTgPanel()">
      <span class="tg-title">텔레그램 설정</span>
      <span class="tg-arrow" id="tg-arrow">▼</span>
    </div>
    <div class="tg-body" id="tg-body">
      <div class="field-group" style="margin-top:12px">
        <label>Bot Token</label>
        <input id="tg-token" type="text" placeholder="1234567890:ABCdefGHIjklMNOpqrsTUVwxyz" autocomplete="off"/>
      </div>
      <div class="field-group">
        <label>Chat ID</label>
        <input id="tg-chatid" type="text" placeholder="-1001234567890  또는  @채널명" autocomplete="off"/>
      </div>
      <div class="tg-help">
        1. <a href="https://t.me/BotFather" target="_blank">@BotFather</a> → /newbot 으로 Bot Token 발급<br>
        2. 봇을 채널/그룹에 관리자로 추가<br>
        3. Chat ID: 채널의 경우 @채널명, 그룹은 <a href="https://t.me/userinfobot" target="_blank">@userinfobot</a> 으로 확인<br>
        4. 저장된 Token / Chat ID는 이 기기 브라우저에만 저장됩니다
      </div>
    </div>
  </div>

  <!-- STATUS -->
  <div class="status" id="status"></div>

  <!-- AUTO UPDATE BADGE -->
  <div>
    <div class="update-badge">
      <div class="update-dot"></div>
      <span id="update-time-label">매일 06:10 KST 자동 업데이트 · Claude AI 생성</span>
    </div>
  </div>

  <!-- BRIEFING TEXT -->
  <div>
    <div class="sec-label">브리핑 본문</div>
    <div class="brief-box">
      <div class="brief-toolbar">
        <span class="brief-toolbar-l">직접 편집 가능 — 복사 / 텔레그램 전송 시 이 내용이 사용됩니다</span>
        <button class="btn-reset" onclick="resetBriefing()">초기화</button>
      </div>
      <textarea id="briefing-text" spellcheck="false"></textarea>
    </div>
  </div>

  <!-- FINVIZ CHARTS -->
  <div>
    <div class="sec-label">시장 현황 차트 — Finviz</div>
    <div class="finviz-section">

      <!-- S&P 500 Treemap -->
      <div class="chart-card">
        <div class="chart-header">
          <span class="chart-title">S&P 500 히트맵 (시가총액 기준)</span>
          <span class="chart-source">Source: finviz.com</span>
        </div>
        <div class="treemap-wrap" id="treemap-wrap">
          <img
            id="finviz-map-img"
            src="https://finviz.com/map.ashx?t=sec&st=d1&style=1"
            alt="S&P 500 히트맵"
            onload="document.getElementById('treemap-fallback').style.display='none'"
            onerror="showMapFallback()"
            style="min-height:220px;object-fit:cover;"
          />
          <div id="treemap-fallback" class="treemap-overlay" style="display:none">
            <p>Finviz 이미지를 직접 로드할 수 없습니다.<br>(CORS / 인증 정책)<br>아래 버튼으로 Finviz에서 직접 확인하세요.</p>
            <a href="https://finviz.com/map.ashx?t=sec&st=d1" target="_blank" class="btn-open-finviz">Finviz 히트맵 열기 →</a>
          </div>
        </div>
        <div class="finviz-note">
          <span>S&P 500 · 1 Day · Sector</span>
          <a href="https://finviz.com/map.ashx?t=sec&st=d1" target="_blank">finviz.com/map.ashx →</a>
        </div>
      </div>

      <!-- Sector Performance Bar Chart -->
      <div class="chart-card">
        <div class="chart-header">
          <span class="chart-title">섹터별 1일 수익률</span>
          <span class="chart-source" id="sector-date-label">Source: finviz.com / <!--SECTOR_DATE--></span>
        </div>
        <div class="sector-chart" id="sector-chart">
          <!-- Rendered by JS -->
        </div>
        <div class="finviz-note">
          <span>S&P 500 Sectors · 1 Day Performance</span>
          <a href="https://finviz.com/groups.ashx?g=sector&sg=country&v=210&p=d&ta=1" target="_blank">finviz.com/groups.ashx →</a>
        </div>
      </div>

    </div>
  </div>

  <!-- NEWS SECTION — AUTO-GENERATED -->
  <div>
    <div class="sec-label" id="news-sec-label">전일 미국 시장 주요 이슈 — <!--NEWS_DATE--></div>
    <div class="news-card" id="news-card">
      <!--NEWS_HTML-->
    </div>
  </div>

  <!-- KOREA MARKET OUTLOOK — AUTO-GENERATED -->
  <div>
    <div class="sec-label" id="outlook-sec-label">한국 장 전망 — <!--OUTLOOK_DATE--></div>
    <div class="outlook-card" id="outlook-card">
      <!--OUTLOOK_HTML-->
    </div>
  </div>

  <div class="footer" id="footer-text">
    <!--FOOTER_TEXT-->
  </div>

</div><!-- /content -->

<script>
// ═══════════════════════════════════════════════════════
//  BRIEFING TEMPLATE — AUTO-GENERATED BY GITHUB ACTIONS
// ═══════════════════════════════════════════════════════
const TEMPLATE = `<!--BRIEFING_TEMPLATE-->`;

// ═══════════════════════════════════════════════════════
//  섹터 데이터 — AUTO-GENERATED
// ═══════════════════════════════════════════════════════
const SECTORS = <!--SECTORS_JSON-->;

// ═══════════════════════════════════════════════════════
//  INIT
// ═══════════════════════════════════════════════════════
const textarea   = document.getElementById('briefing-text');
const tokenInput = document.getElementById('tg-token');
const chatInput  = document.getElementById('tg-chatid');

function load(key, fallback) {
  try { return localStorage.getItem(key) || fallback; } catch(e) { return fallback; }
}
function save(key, val) {
  try { localStorage.setItem(key, val); } catch(e){}
}

window.addEventListener('DOMContentLoaded', () => {
  // Header date
  const now = new Date();
  document.getElementById('header-date').textContent =
    `<!--RUN_KST--> KST — 미국장 <!--DATA_DATE--> 마감 기준`;

  // Load saved or template
  textarea.value = load('brief_v3', TEMPLATE);
  tokenInput.value = load('tg_token', '');
  chatInput.value  = load('tg_chatid', '');

  // Persist edits
  textarea.addEventListener('input', () => save('brief_v3', textarea.value));
  tokenInput.addEventListener('input', () => save('tg_token', tokenInput.value.trim()));
  chatInput.addEventListener('input',  () => save('tg_chatid', chatInput.value.trim()));

  // Landing date
  const ld = document.getElementById('landing-date');
  if (ld) {
    const n = new Date();
    ld.textContent = `<!--RUN_KST--> KST  ·  미국장 <!--DATA_DATE--> 마감 기준`;
  }

  // Render sector chart
  renderSectorChart();

  // Finviz img: onload/onerror handles fallback
});

// ═══════════════════════════════════════════════════════
//  SECTOR CHART
// ═══════════════════════════════════════════════════════
function renderSectorChart() {
  const container = document.getElementById('sector-chart');
  const maxAbs = Math.max(...SECTORS.map(s => Math.abs(s.val)));

    const sorted = [...SECTORS].sort((a,b) => b.val - a.val);

  container.innerHTML = sorted.map(s => {
    const pct = (Math.abs(s.val) / maxAbs) * 100;
    const isUp = s.val >= 0;
    const sign = isUp ? '+' : '';
    const cls  = isUp ? 'up' : 'down';
    const barWidth = pct.toFixed(1);

    const barHtml = isUp
      ? `<div class="bar-fill up" style="width:${barWidth}%">${sign}${s.val.toFixed(2)}%</div>`
      : `<div class="bar-fill down" style="width:${barWidth}%">${sign}${s.val.toFixed(2)}%</div>`;

    return `
      <div class="sector-row">
        <div class="sector-name">${s.name}</div>
        <div class="bar-track">${barHtml}</div>
      </div>`;
  }).join('');
}

// ═══════════════════════════════════════════════════════
//  FINVIZ MAP FALLBACK
// ═══════════════════════════════════════════════════════
function showMapFallback() {
  document.getElementById('treemap-fallback').style.display = 'flex';
}

// ═══════════════════════════════════════════════════════
//  TG PANEL TOGGLE
// ═══════════════════════════════════════════════════════
function toggleTgPanel() {
  const body  = document.getElementById('tg-body');
  const arrow = document.getElementById('tg-arrow');
  body.classList.toggle('open');
  arrow.classList.toggle('open');
}

// ═══════════════════════════════════════════════════════
//  COPY
// ═══════════════════════════════════════════════════════
function copyBriefing() {
  const text = textarea.value;
  if (navigator.clipboard && window.isSecureContext) {
    navigator.clipboard.writeText(text)
      .then(() => showStatus('ok', '클립보드에 복사되었습니다.', 3000))
      .catch(() => fallbackCopy(text));
  } else {
    fallbackCopy(text);
  }
}
function fallbackCopy(text) {
  textarea.select();
  textarea.setSelectionRange(0, 99999);
  try {
    document.execCommand('copy');
    showStatus('ok', '클립보드에 복사되었습니다.', 3000);
  } catch(e) {
    showStatus('err', '복사 실패. 텍스트를 직접 선택 후 복사하세요.');
  }
}

// ═══════════════════════════════════════════════════════
//  TELEGRAM SEND
// ═══════════════════════════════════════════════════════
function sendToTelegram() {
  sendTgMessage();
}

async function sendTgMessage() {
  const token  = tokenInput.value.trim();
  const chatId = chatInput.value.trim();

  if (!token || !chatId) {
    const body = document.getElementById('tg-body');
    if (!body.classList.contains('open')) toggleTgPanel();
    showStatus('err', 'Bot Token과 Chat ID를 먼저 입력해주세요.');
    return;
  }

  const text = textarea.value.trim();
  if (!text) { showStatus('err', '전송할 내용이 없습니다.'); return; }

  showStatus('loading', '텔레그램으로 전송 중...');

  const chunks = splitText(text, 4000);
  const url = `https://api.telegram.org/bot${token}/sendMessage`;

  try {
    for (let i = 0; i < chunks.length; i++) {
      const res  = await fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ chat_id: chatId, text: chunks[i] })
      });
      const data = await res.json();
      if (!data.ok) {
        let msg = data.description || '알 수 없는 오류';
        if (msg.includes('chat not found')) msg = 'Chat not found — 봇이 채널/그룹에 추가되지 않았거나 Chat ID가 잘못되었습니다.';
        if (msg.includes('Unauthorized'))   msg = 'Unauthorized — Bot Token이 잘못되었습니다.';
        showStatus('err', `전송 실패: ${msg}`);
        return;
      }
      if (i < chunks.length - 1) await sleep(600);
    }
    showStatus('ok', `전송 완료 ${chunks.length > 1 ? `(${chunks.length}개 메시지)` : ''}`, 5000);
  } catch(e) {
    showStatus('err', `네트워크 오류: ${e.message}`);
  }
}

// ═══════════════════════════════════════════════════════
//  HELPERS
// ═══════════════════════════════════════════════════════
function resetBriefing() {
  if (confirm('브리핑을 초기 템플릿으로 초기화하시겠습니까?')) {
    textarea.value = TEMPLATE;
    save('brief_v3', TEMPLATE);
  }
}

function splitText(text, max) {
  if (text.length <= max) return [text];
  const chunks = [];
  let rem = text;
  while (rem.length > 0) {
    if (rem.length <= max) { chunks.push(rem); break; }
    let slice = rem.slice(0, max);
    const nl = slice.lastIndexOf('\n');
    if (nl > max * 0.6) slice = rem.slice(0, nl);
    chunks.push(slice);
    rem = rem.slice(slice.length).replace(/^\n/, '');
  }
  return chunks;
}

let statusTimer = null;
function showStatus(type, msg, autoHideMs) {
  const el = document.getElementById('status');
  el.className = `status show ${type}`;
  el.textContent = msg;
  if (statusTimer) clearTimeout(statusTimer);
  if (autoHideMs) statusTimer = setTimeout(() => { el.classList.remove('show'); }, autoHideMs);
}

function sleep(ms) { return new Promise(r => setTimeout(r, ms)); }

function enterBriefing() {
  const landing = document.getElementById('landing');
  const main    = document.getElementById('main-content');
  landing.classList.add('hide');
  setTimeout(() => {
    landing.style.display = 'none';
    main.classList.add('show');
  }, 350);
}
</script>

</div><!-- /main-content -->
</body>
</html>
